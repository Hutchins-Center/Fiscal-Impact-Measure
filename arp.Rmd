------------------------------------------------------------------------

---
title: 'American Rescue Plan'

author: ' Manuel Alcala Kovalski and Sophia Campbell'
date: "`r Sys.Date()`"
header-includes:
   - \usepackage[default]{sourcesanspro}
   - \usepackage[T1]{fontenc}
mainfont: SourceSansPro
output:
  html_document:
    toc: true # table of content true
    toc_float: true
    toc_depth: 2
    number_sections: false 
    theme: united
    highlight: zenburn 
    hig.retina: 3
    self_contained: yes
    css: [style.css]
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  echo = FALSE,
  fig.align = 'center',
  warning = FALSE,
  message = FALSE,
  cache = FALSE,
  fig.path = 'figures/knitr'
  
  
)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
library(targets)
library(tarchetypes)
source('R/packages.R')
source('R/functions.R')
library('conflicted')
conflict_prefer('filter', 'dplyr')
conflict_prefer("month", "lubridate")
conflict_prefer('year', 'lubridate')
conflict_prefer('lag', 'dplyr')

current_month <- glue::glue(lubridate::month(lubridate::today()), '-', lubridate::year(lubridate::today()))
components <- get_components_names()

library('targets')
library('tidyverse')
library('magrittr')
library('ggthemes')
library('ggtext')
library('ggthemes')
library('gridExtra')
library('fim')
library('lubridate')
library('glue')
library('readxl')
library('tsibble')
library('gghutchins')

conflicted::conflict_prefer('filter', 'dplyr')
conflicted::conflict_prefer('geom_col', 'ggplot2')
conflicted::conflict_prefer('geom_line', 'ggplot2')


last_month <- get_previous_month()
current_month <- get_current_month()
tar_load(last_hist_date)
tar_load(last_proj_date)
tar_load(fim)
theme_set(theme_hutchins())
```


```{r}


fim %>% 
  filter(date > '2020-12-31' & date < '2026-12-31') %>% 
  mutate(arp_cont = federal_ui_arp + rebate_checks_arp + aid_to_small_businesses + health_grants_arp + non_health_grants + other_direct_aid + other_vulnerable) %>% 
  select(date, arp_cont) %>% 
  pivot_longer(arp_cont) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col() +
  labs(title = 'Money spent due to American Rescue Plan',
       subtitle = 'Includes unemployment insurance, rebate checks, aid to small businesses, health grants, grants to S&L governments, direct aid to households and aid to vulnerable individuals')  +
  scale_fill_hutchins() +
  scale_y_continuous(labels = scales::dollar_format(),
                     limits = c(0, 3000), breaks = seq(0, 3000, 500))


fim %>% 
  filter(date > '2020-12-31' & date < '2026-12-31') %>% 
  mutate(arp_cont = federal_ui_arp + rebate_checks_arp + aid_to_small_businesses + health_grants_arp + non_health_grants + other_direct_aid + other_vulnerable) %>% 
  select(date, arp_cont) %>% 
  summarise(cumsum(arp_cont))
```
```{r}
arp_spending <-
  fim %>% 
   mpc_arp_non_health_grants() %>% 
      summarize(date, non_health_grants_post_mpc,
                across(.cols = all_of(c('federal_ui_arp', 'state_ui_arp', 'other_vulnerable')),
                    .fns = ~ mpc_vulnerable_arp(.x),
                    .names = '{.col}_post_mpc'),
             across(.cols = all_of(c('rebate_checks_arp', 'other_direct_aid')),
                    .fns = ~ mpc_direct_aid_arp(.),
                    .names = '{.col}_post_mpc'),
             health_grants_arp_post_mpc = mpc_health_outlays(health_grants_arp),
             aid_to_small_businesses_post_mpc = mpc_small_businesses_arp((aid_to_small_businesses)) 
      ) %>% 
  rename_with(~ gsub('_post_mpc', '', .x)) %>% 
    filter(date > '2020-12-31' & date < '2025-03-30')
```

```{r social-benefits}

library(directlabels)
arp_spending %>% 
  mutate(date = yearquarter(date)) %>% 
  as_tsibble(index = date) %>% 
  select(date, federal_ui_arp,  rebate_checks_arp, other_vulnerable, other_direct_aid) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  # geom_line(alpha = 0.5) +
  # ggplot2::geom_point() +
  geom_col(position = 'dodge') +
  scale_fill_hutchins(labels = c('Federal UI',  'Rebate checks', 'Other vulnerable', 'Other direct aid'), pal = 'mixed') +
  theme(
    legend.position = 'top'
  ) +
  scale_x_yearquarter() +
  labs(title  = 'Social benefits American Rescue Plan') 
  
```

```{r other}
arp_spending %>% 
  mutate(date = yearquarter(date)) %>% 
  as_tsibble(index = date) %>% 
  select(date, health_grants_arp, non_health_grants, aid_to_small_businesses) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  # geom_line(alpha = 0.5) +
  # ggplot2::geom_point() +
  geom_col(position = 'dodge', aes(fill = name)) +
  scale_fill_hutchins(rev = TRUE) +
  theme(
    legend.position = 'top'
  ) +
  scale_x_yearquarter() +
  labs(title  = 'Social benefits American Rescue Plan') 

fim %>% 
  select(date, non_health_grants) %>% 
  filter(date > '2020-12-31') %>% 
  pivot_longer(non_health_grants) %>% 
  ggplot(aes(x = date, y = value, fill =  name)) +
  geom_col() +
  scale_fill_hutchins()
```
```{r}
arp_spending %>% 
  summarise(date, 
            arp_spending = health_grants_arp + non_health_grants + aid_to_small_businesses + federal_ui_arp +  rebate_checks_arp + other_vulnerable + other_direct_aid) %>% 
  pivot_longer(arp_spending) %>% 
  ggplot(mapping = aes(x = date, y = value, fill = name)) +
  geom_col() +
  scale_fill_hutchins() +
  scale_y_continuous(labels = scales::dollar_format()) 
```
```{r arp-components}
tar_load(fim)
arp_cont <-
  fim %>% 
   filter(date > '2020-12-31' & date < '2024-12-31') %>% 
   select(date, federal_ui_arp_cont, rebate_checks_arp_cont, other_direct_aid_cont, other_vulnerable_cont, aid_to_small_businesses_cont, non_health_grants_cont, health_grants_arp_cont,
          federal_cont, federal_cont_no_arp, fiscal_impact)

arp_cont %>% 
  select(date, federal_ui_arp_cont, rebate_checks_arp_cont, other_direct_aid_cont, other_vulnerable_cont) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(position = 'dodge') + 
  scale_fill_hutchins(labels = c('UI',  'Other Direct Aid', 'Other Vulnerable', 'Rebate Checks')) +
  theme(legend.position = 'top')
 
```
```{r}
arp_cont %>% 
  select(date, aid_to_small_businesses_cont, health_grants_arp_cont, non_health_grants_cont) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value / 100, fill = name)) +
  geom_col(position = 'dodge') + 
  scale_fill_hutchins(labels = c('Aid to small businesses', 'Health grants', 'Non-health grants')) +
  theme(legend.position = 'top')  +
  scale_y_continuous(labels = scales::label_percent(),limits = c(-0.02, 0.02), breaks = seq(-0.02, 0.02, 0.0025))
```
```{r}

arp_cont %>% 
  summarise(date, 
           federal_cont_no_arp,
            federal_cont, fiscal_impact) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(position = 'dodge') +
  scale_fill_hutchins(rev = TRUE) +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  labs(title = 'Contribution of the Federal Transfers in the American Rescue Plan') +
  theme(legend.position = 'top')

```

```{r}
arp_cont %>% 
  summarise(date, 
            arp_transfers =  health_grants_arp_cont +
            federal_ui_arp_cont + rebate_checks_arp_cont + other_direct_aid_cont + other_vulnerable_cont + aid_to_small_businesses_cont,
            arp_grants = non_health_grants_cont,
            federal_cont) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col() +
  scale_fill_hutchins(rev = TRUE, labels = c('Grants', 'Transfers', 'Federal Purchases')) +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  labs(title = 'Contribution of the Federal Transfers in the American Rescue Plan') +
  theme(legend.position = 'top')
  
```


```{r arpa}
arp_cont %>% 
  summarise(date, 
            arp_cont =  health_grants_arp_cont + non_health_grants_cont +
            federal_ui_arp_cont + rebate_checks_arp_cont + other_direct_aid_cont + other_vulnerable_cont + aid_to_small_businesses_cont ) %>% 
  pivot_longer(-date) %>% 
  mutate(date =  yearquarter(date)) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col() +
  scale_fill_hutchins() +
  scale_y_continuous(labels = scales::label_percent(scale = 1, accuracy = 1),
                     breaks = seq(-2, 6, 1)) +
       scale_x_yearquarter(breaks = waiver(),
                          date_breaks = '3 months',
                          date_labels = "Q%q") +
      facet_grid( ~ year(date),
                  space = "free_x",
                  scales = "free_x",
                  switch = "x")  +
geom_hline(yintercept = 0, size = 0.4, linetype = 2, alpha =  1, color = 'black') +
  labs(title = 'Contribution of the American Rescue Plan to real GDP growth', 
       caption =  '**Source**: Hutchins Center calculations from Bureau of Economic Analysis and Congressional Budget Office data')
```
```{r arp-commponents-dos}
arp_cont %>% 
  select(date, 
            health_grants_arp_cont , non_health_grants_cont ,
            federal_ui_arp_cont , rebate_checks_arp_cont , other_direct_aid_cont, other_vulnerable_cont, aid_to_small_businesses_cont ) %>% 
  mutate(date =  yearquarter(date)) %>% 
  pivot_longer(-date) %>% 
  filter(date < yearquarter('2025 Q1')) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(width = 30) +
  scale_fill_hutchins(labels = c('Aid to small businesses','Unemployment insurance',  'Health grants', 'Aid to S&L governments', 'Other direct aid', 'Aid to vulnerable households', 'Rebate Checks' )) +
  scale_y_continuous(labels = scales::label_percent(scale = 1, accuracy  =  1),
                     breaks = seq(-3, 6, 1)) +
  scale_x_yearquarter(breaks = '6 months') +
  labs(title = 'Components of the contribution of the American Rescue Plan Act to real GDP growth', 
       caption = '**Source**: Hutchins Center calculations from Bureau of Economic Analysis and Congressional Budget Office data') +
  theme(legend.position = 'bottom',
        legend.direction  = 'horizontal',
        legend.justification = 'left') +
  guides(fill=guide_legend(nrow=3)) +
      scale_x_yearquarter(breaks = waiver(),
                          date_breaks = '3 months',
                          date_labels = "Q%q") +
      facet_grid( ~ year(date),
                  space = "free_x",
                  scales = "free_x",
                  switch = "x")  +
geom_hline(yintercept = 0, size = 0.35, linetype = 2, alpha =  0.8)
```

```{r arp-dodge}
arp_cont %>% 
  select(date, 
            health_grants_arp_cont , non_health_grants_cont ,
            federal_ui_arp_cont , rebate_checks_arp_cont , other_direct_aid_cont, other_vulnerable_cont, aid_to_small_businesses_cont ) %>% 
  mutate(date =  yearquarter(date)) %>% 
  pivot_longer(-date) %>% 
  filter(date < yearquarter('2023 Q1')) %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(
           position = 'dodge') +
  scale_fill_hutchins(labels = c('Aid to small businesses','Unemployment insurance',  'Health grants', 'Aid to S&L governments', 'Other direct aid', 'Aid to vulnerable households', 'Rebate Checks' )) +
  scale_y_continuous(labels = scales::label_percent(scale = 1, accuracy  =  1),
                     breaks = seq(-3, 6, 1)) +
  scale_x_yearquarter(breaks = '6 months') +
  labs(title = 'Components of the contribution of the American Rescue Plan Act to real GDP growth', 
       caption = '**Source**: Hutchins Center calculations from Bureau of Economic Analysis and Congressional Budget Office data') +
  theme(legend.position = 'bottom',
        legend.direction  = 'horizontal',
        legend.justification = 'left') +
  guides(fill=guide_legend(nrow=3)) +
      scale_x_yearquarter(breaks = waiver(),
                          date_breaks = '3 months',
                          date_labels = "Q%q") +
      facet_grid( ~ year(date),
                  space = "free_x",
                  scales = "free_x",
                  switch = "x")  +
geom_hline(yintercept = 0, size = 0.35, linetype = 2, alpha =  0.8)
```

```{r}

df <- 
  fim %>% 
  select(date, federal_unemployment_insurance, federal_subsidies, rebate_checks, federal_cgrants, federal_ui_arp, aid_to_small_businesses, non_health_grants, rebate_checks_arp)  %>%
  mpc_arp_non_health_grants() %>% 
  summarise(date, 
            federal_ui_2020 = mpc_unemployment_insurance(federal_unemployment_insurance),
            federal_ui_arp = mpc_vulnerable_arp(federal_ui_arp),
            federal_subsidies_2020 = if_else(date < '2021-03-31',
                                             mpc_subsidies(federal_subsidies),
                                             mpc_subsidies_second_draw(federal_subsidies)),
            aid_to_small_businesses = mpc_small_businesses_arp(aid_to_small_businesses),
            non_health_grants = non_health_grants_post_mpc,
            rebate_checks_2020 = mpc_rebate_checks(rebate_checks),
            rebate_checks_arp = mpc_direct_aid_arp(rebate_checks_arp),
            federal_cgrants
            
            )
```

```{r ui}
df %>% 
  select(date, federal_ui_arp, federal_ui_2020) %>% 
  pivot_longer(-date) %>% 
  filter(date > '2019-12-31' & date < '2023-12-31') %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(position = 'dodge') +
  scale_fill_hutchins() +
  theme(legend.position = 'top')
```
```{r}
df %>% 
  select(date, rebate_checks_2020, rebate_checks_arp) %>% 
  pivot_longer(-date) %>% 
  filter(date > '2019-12-31' & date < '2023-12-31') %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(position = 'dodge') +
  scale_fill_hutchins() +
  theme(legend.position = 'top') +
  scale_y_continuous(limits = c(0, 500)) +
  scale_x_yearquarter(date_breaks = '6 months')
```

```{r}
df %>% 
  select(date, federal_subsidies_2020, aid_to_small_businesses) %>% 
  pivot_longer(-date) %>% 
  filter(date > '2019-12-31' & date < '2023-12-31') %>% 
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col(position = 'dodge') +
  scale_fill_hutchins() +
  theme(legend.position = 'top')
```

```{r}
df %>% 
  select(date, federal_cgrants, non_health_grants) %>% 
  pivot_longer(-date) %>% 
  filter(date > '2019-12-31' & date < '2030-12-31') %>% 
  ggplot(aes(x = date, y = value, color = name)) +
  geom_line() +
  scale_color_hutchins() +
  theme(legend.position = 'top')
```

