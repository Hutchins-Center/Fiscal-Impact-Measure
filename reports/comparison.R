---
  title: "FIM Update Summary"
runtime: shiny
output:
  html_document:
  df_print: paged
---
  
  
  ```{r, setup, include = FALSE}
knitr::opts_chunk$set( warning = FALSE, message = FALSE, echo = FALSE)
```


```{r, include = FALSE}
library(tidyverse)
library(stringr)
library(reshape2)
library(rmarkdown)
library(TTR)
library(data.table)
library(DataExplorer)
library(shiny)
library(rsconnect)
```

The purpose of this document is to document changes between the previous FIM update and the most recent one. 


## FIM 08/04

### Table 


The table below shows our FIM projections on 08/04/2020:
  ```{r cars}
fim_08 <- read_csv("08-2020/fim-projections-2020-08-04.csv")
fim_08 <- fim_08 %>% select(-X1) %>% filter(date > "2019-12-31")  %>% mutate_if(is.numeric, round, 2)
fim_08$date <- as.Date(fim_08$date)
inputPanel(
  selectInput(
    inputId = "col1",
    label = "Select columns",
    choices = names(fim_08)[-1], 
    multiple = TRUE
  )
)
mydata <- reactive({
  fim_08 %>%
    select(date, input$col1)
})
library(DT)
renderDT({
  DT::datatable(mydata(), class = "cell-border stripe", rownames = F, editable = TRUE, extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})
```


### Plots


It may also be helpful to visualize these projections. 
```{r, echo = FALSE}
inputPanel(
  selectInput(inputId = "yaxis",label = "Y-axis",choices = names(fim_08)[-1])
)
renderPlot({
  ggplot(fim_08, aes_string("date", input$yaxis)) + geom_line() 
})
```


## September FIM

### Levels

#### Table


```{r}
fim_09 <- read_csv("09-2020/fim-projections-2020-09-11.csv") 
fim_09 <- fim_09 %>% select(-X1)
fim_09 <- fim_09 %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
inputPanel(
  selectInput(
    inputId = "col3",
    label = "Select columns",
    choices = names(fim_09)[-1], 
    multiple = TRUE
  )
)
mydata3 <- reactive({
  fim_09 %>%
    select(date, input$col3)
})
library(DT)
renderDT({
  DT::datatable(mydata3(), class = "cell-border stripe", rownames = F, editable = TRUE, extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})
```


#### Plots



```{r, echo = FALSE}
inputPanel(
  selectInput(inputId = "yaxis3",label = "Y-axis",choices = names(fim_09)[-1])
)
renderPlot({
  ggplot(fim_09, aes_string("date", input$yaxis3)) + geom_line() 
})
```

### Rates

We can also look at the quarterly growth rate for each variable. 

#### Table 

```{r}
# fim_09_rate <- fim_09 %>% select(-date) %>% mutate(./lag(.) - 1) %>% 

fim_09_rates <- fim_09 %>% mutate_at(.funs = list(rate = ~./lag(.) - 1), .vars = 2:length(fim_09)) %>% select(date, ends_with("rate")) %>% mutate_if(is.numeric, round, 2)
inputPanel(
  selectInput(
    inputId = "rate09",
    label = "Select columns",
    choices = names(fim_09_rates)[-1], 
    multiple = TRUE
  )
)
rates_09 <- reactive({
  fim_09_rates %>%
    select(date, input$rate09)
})
library(DT)
renderDT({
  DT::datatable(rates_09(), class = "cell-border stripe", rownames = F, editable = TRUE, extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})
```

#### Plot
```{r}
inputPanel(
  selectInput(inputId = "rateaxis1",label = "Y-axis",choices = names(fim_09_rates)[-1])
)
renderPlot({
  ggplot(fim_09_rates, aes_string("date", input$rateaxis1)) + geom_line() 
})
```




## Difference in projections





```{r, include = FALSE}
fim_new <- fim_09 %>% mutate(id = "Updated") %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
fim_old <- fim_08 %>% mutate(id = "Previous") %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
fim_old <- fim_old %>% select(-starts_with("add"))
fim_new <- fim_new %>% select(-starts_with("add"))
fim_09 <- fim_09 %>% select(-starts_with("add"))
fim_08 <- fim_08 %>% select(-starts_with("add"))
fim_both <- rbind(fim_old, fim_new) %>% group_by(id, date)
fim_diff <- fim_09 - fim_08
fim_diff <- fim_diff %>% mutate_if(is.numeric, round, 2) %>% mutate(date = fim_09$date)
```

```{r}
inputPanel(
  selectInput(
    inputId = "col4",
    label = "Select columns",
    choices = names(fim_diff)[-1], 
    multiple = TRUE
  )
)
mydata4 <- reactive({
  fim_diff %>%
    select(date, input$col4)
})
library(DT)
renderDT({
  DT::datatable(mydata4(), class = "cell-border stripe", rownames = F, editable = TRUE, extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})
```


We can also visualize both FIM's side by side


```{r both, echo = FALSE}
inputPanel(
selectInput(inputId = "yaxis4",label = "Y-axis",choices = names(fim_both)[-1])
)
renderPlot({
  ggplot(fim_both, aes_string("date", input$yaxis4, group = "id", color = "id")) + geom_line() 
})
```

### Rates

Calculations for the percentage difference in levels from the 08/04 projections to 09/04 projections. 

#### Table

```{r}
 fim_diff_percent <- (fim_09[,2:length(fim_09)] - fim_08[,2:length(fim_08)])
 fim_diff_percent <- (fim_diff_percent/fim_08[,2:length(fim_08)]) 
 fim_diff_percent <- bind_cols(fim_09$date, fim_diff_percent)
 
fim_diff_percent <- fim_diff_percent %>% rename(date = ...1)
 fim_diff_percent <- fim_diff_percent  %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
```


```{r}
inputPanel(
  selectInput(
    inputId = "col5",
    label = "Select columns",
    choices = names(fim_diff_percent)[-1], 
    multiple = TRUE
  )
)
mydata5 <- reactive({
fim_diff_percent %>%
    select(date, input$col5)
})
library(DT)
renderDT({
  DT::datatable(mydata5(), class = "cell-border stripe", rownames = F, editable = TRUE, extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
})
```


#### Plots


```{r percent, echo = FALSE}
inputPanel(
selectInput(inputId = "yaxis5",label = "Y-axis",choices = names(fim_diff_percent)[-1])
)
renderPlot({
  ggplot(fim_diff_percent, aes_string("date", input$yaxis5)) + geom_line() +  scale_y_continuous(labels=scales::percent) 
})
```