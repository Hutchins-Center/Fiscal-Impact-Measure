---
title: "R Notebook"
output: html_notebook
runtime: shiny
---

```{r cars}
library('DataExplorer')
fim_08.2020 <- read_csv("08-2020/fim-projections-2020-08-04.csv") 
fim_08.2020 <- fim_08.2020 %>% select(-X1)

```


In the second estimate, real GDP decreased 31.7 percent in the second quarter, an upward revision of 1.2 percentage points from the previous estimate issued last month. The revision primarily reflected upward revisions to private inventory investment and PCE.

Specifically,

* Q1 Revisions
  + Wages and Salaries
    - BEA revised estimates of first-quarter wages and salaries, personal taxes, and contributions for government social insurance, based on updated data from the BLS Quarterly Census of Employment and Wages program. 
    - Wages and salaries are now estimated to have increased $103.6 billion in the first quarter of 2020, a downward revision of $3.4 billion. 
    
* Q2 Revisions
  + Real GDP
    - Decreased 31.7 percent (upward revision of 1.2 percentage points)
    - Reflects upward revisions to private inventory investment and PCE
  + Corporate profits
    - Profits from current production decreased $226.9 billion in Q2 (Q1 decrease was $276.2 billion)
    - Profits of domestic financial corporations increased $39.5 billion (Q1 decrease was $42.2 billion)
    - Profits of domestic nonfinancial corporations decreased $170.1 billion (Q1 decrease was $190.5 billion)
    - Rest-of-the-world profits decreased $96.2 billion (Q1 decrease was $43.5 billion)
    
## Previous FIM

```{r}
fim_08.2020 %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
```

## Updated FIM

```{r}
fim %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
```

## Difference in projections
```{r}
fim_diff <- fim - fim_08.2020 
fim_diff <- fim_diff %>% mutate(date = fim$date) 
fim_diff <- fim_diff %>% filter(date > "2019-12-31")

fim_diff %>% mutate_if(is.numeric, round, 2)
```


```{r}
fim_diff_percent <- (fim - fim_08.2020)

fim_diff_percent <- (fim_diff_percent/fim_08.2020)*100 

fim_diff_percent <- fim_diff_percent %>% mutate(date = fim$date) %>% filter(date > "2019-12-31")
fim_diff_percent %>% mutate_if(is.numeric, round, 2)
```
```{r}
fim_new <- fim %>% mutate(id = "Updated") %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)
fim_old <- fim_08.2020 %>% mutate(id = "Previous") %>% filter(date > "2019-12-31") %>% mutate_if(is.numeric, round, 2)

fim_both <- rbind(fim_old, fim_new) %>% group_by(id, date)

ggplot(fim_both, aes(x = date, y = fim_bars, group = id, color = id)) + geom_line()
```
```{r}
ggplot(fim_both, aes(x = date, y = fim_bars, group = id, color = id)) + geom_line()

compare <- function(var){
  ggplot(fim_both, aes(x = date, y = var, group = id, color = id )) + geom_line()
}

#lapply(fim_both[,2:length(fim_both)], compare)
```

```{r interactive, echo = FALSE}
library(shiny)
selectInput(
  'variable', label = 'Var', choices = colnames(fim_both[,c(-1,-96)]),
  selected = 'fim_bars'
)

renderPlot({
  ggplot(fim_both, aes(date, input$variable, group = id, color = id)) + geom_line()
})
```

```{r, echo = FALSE}
library(ggplot2)
library(gridExtra)
library(grid)
library(wesanderson)

# Do you want to render the output to PDFs and JPGs?
render = F

######COVID19 changes#####
#manually added end date for recesions that's equal to the start of the current month
end_date_reccession = as.Date("2020-07-31") #last date a month after the end of the current quarter

##want to add subsidies to taxes and transfers
fim <- fim %>% 
  mutate(taxes_transfers_cont = taxes_transfers_cont + subsidies_cont,
         state_taxes_transfers_cont = state_taxes_transfers_cont + state_subsidies_cont,
         federal_taxes_transfers_cont = federal_taxes_transfers_cont + federal_subsidies_cont
  )

##renamed "Taxes and Transfers" with "taxes, transfers, and subsidies"
######

# set plot formats, theme 
uni.theme = theme_bw() + theme(legend.position = "bottom", panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank() , plot.margin=unit(c(1.2,.5,.5,.5),"cm") , plot.title = element_text(size=12, face = "bold"), plot.subtitle = element_text(size=10) , plot.caption = element_text(size = 9), legend.text=element_text(size=10), legend.title=element_blank(),legend.spacing.y = unit(2, 'cm')) # , legend.margin = unit(c(rep(-.8, 4)),"cm")

guidez =  guides(fill = guide_legend(keywidth = unit(0.8, "cm"), keyheight = unit(0.4, "cm"), ncol = 1), colour = guide_legend(keywidth = unit(0.8, "cm"), keyheight = unit(0.05, "cm"), ncol = 1))

taxes_transfers_green = rgb(27, 149, 83,  maxColorValue = 255)
state_local_purple = rgb(174, 104, 169,  maxColorValue = 255)
federal_blue = rgb(33, 152, 199,  maxColorValue = 255)
total_pink = rgb(231, 97, 159, maxColorValue = 255)
colourz = c("black",taxes_transfers_green, state_local_purple, federal_blue, total_pink, wes_palette("Royal2"), wes_palette("Royal2"))

#max value for the y axis
max_y = ceiling(max(fim$fim_bars, na.rm = TRUE)) + 1
#minimum valye for the y axis
min_y = floor(min(fim$fim_bars, na.rm = TRUE)) - 1

# helper function for line plots
lp <- function(data, labelz = NULL, ylabel = NULL, t = NULL, sub = NULL, cap = NULL, start.date = "2000-01-01", end.date = last_proj_date, colorz = colourz) {
  df_plot <- data
  colnames(df_plot) = c("date", labelz)
  df_plot <- melt(df_plot, id = "date")
  df_plot <- df_plot[which(df_plot$date <= end.date & df_plot$date >= start.date), ]
  
  leg_exists = NULL
  if(is.null(labelz)){
    leg_exists = theme(legend.position="none")
  }
  
  shade = data.frame(start = as.Date(Sys.Date()), end = as.Date(end.date,  "%Y-%m-%d"))
  
  ggplot() + geom_line(data = df_plot, aes_string("date", "value", colour = "variable")) +     
    uni.theme + 
    scale_x_date(breaks = 0, date_breaks = "4 years", date_labels = "%Y", limits = as.Date(c(start.date,end.date))) + 
    labs(title = t, subtitle = sub, caption = cap) + ylab(ylabel) + xlab("") +
    scale_colour_manual(values=colorz) + leg_exists
}

# helper function for bar plots
bp <- function(data, labelz = NULL, ylabel = NULL, t = NULL, sub = NULL, cap = NULL, start.date = "2000-01-01", end.date = last_proj_date, colorz = colorz) {
  df_plot <- data
  colnames(df_plot) = c("date", labelz)
  df_plot <- melt(df_plot, id = "date")
  
  leg_exists = NULL
  if(is.null(labelz)){
    leg_exists = theme(legend.position="none")
  }
  
  ggplot() + geom_bar(data = df_plot, aes_string("date", "value", fill = "variable"), stat = "identity", width = 50) + 
    uni.theme + 
    scale_x_date(breaks = 0, date_breaks = "2 years", date_labels = "%Y", limits = as.Date(c(start.date,end.date))) + 
    labs(title = t, subtitle = sub, caption = cap) + ylab(ylabel) + xlab("") +
    scale_fill_manual(values=colorz) + leg_exists 
  
}

# data frames for projection and recession shading
projection = data.frame(start = as.Date(last_hist_date + 40) , end = last_proj_date)
recessions = data.frame(start = hist$date[which(diff(hist$recessq)==2)], end = c(hist$date[which(diff(hist$recessq)==-2)],end_date_reccession)[-1])

# gg objects for recession and projection shading
projection_shade =  geom_rect(data = projection, aes(xmin = start, xmax = end, ymin=-Inf, ymax=+Inf), fill = 'yellow', alpha = 0.1)
recession_shade = geom_rect(data = recessions, aes(xmin = start, xmax = end, ymin=-Inf, ymax=+Inf), fill = 'grey', alpha = 0.3)

# gg object for the moving-average line
moving_average = function(){
  geom_line(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-Quarter Moving-Average")) +  
  geom_point(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-Quarter Moving-Average")) +
  scale_shape_manual(" ", values=c("4-Quarter Moving-Average" ="black"))
}


```


## Updated FIM

```{r}

# construct figures

fimbars1_new = bp(data = fim[,c("date","fim_bars")], 
              labelz = c(" Quarterly fiscal impact"), 
              start.date = "2000-01-01", 
              end.date = last_proj_date,
              t = "Hutchins Center Fiscal Impact Measure: Total", 
              sub = "Fiscal Policy Contribution to Real GDP Growth, percentage points", 
              colorz = total_pink, 
              cap = "Source: Hutchins Center calculations from Bureau of Economic Analysis and Congressional Budget Office data; \ngrey shaded areas indicate recessions and yellow shaded areas indicate projection.") + 
  geom_line(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-quarter moving-average")) +  
  geom_point(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-quarter moving-average"), size = 1) +
  scale_color_manual(" ", values=c("4-quarter moving-average" ="black", "4-quarter moving-average" ="black")) +
  geom_text(aes(x=Sys.Date()+350, y = max_y), label = "Projection", cex = 2) + 
  projection_shade + 
  recession_shade + 
  ylim(min_y, max_y) + 
  guidez

fimbars1_new


```
```{r}

# construct figures

fimbars1_old = bp(data = fim_08.2020[,c("date","fim_bars")], 
              labelz = c(" Quarterly fiscal impact"), 
              start.date = "2000-01-01", 
              end.date = last_proj_date,
              t = "Hutchins Center Fiscal Impact Measure: Total", 
              sub = "Fiscal Policy Contribution to Real GDP Growth, percentage points", 
              colorz = total_pink, 
              cap = "Source: Hutchins Center calculations from Bureau of Economic Analysis and Congressional Budget Office data; \ngrey shaded areas indicate recessions and yellow shaded areas indicate projection.") + 
  geom_line(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-quarter moving-average")) +  
  geom_point(data = fim, aes(x = date, y = fim_bars_ma, colour = "4-quarter moving-average"), size = 1) +
  scale_color_manual(" ", values=c("4-quarter moving-average" ="black", "4-quarter moving-average" ="black")) +
  geom_text(aes(x=Sys.Date()+350, y = max_y), label = "Projection", cex = 2) + 
  projection_shade + 
  recession_shade + 
  ylim(min_y, max_y) + 
  guidez

fimbars1_old


```


